<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Quiz Game</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.3/dist/teachablemachine-image.min.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #main-container {
            display: flex;
            width: 100%;
            height: 100%;
        }
        #quiz-container {
            flex: 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding: 20px;
            overflow-y: auto;
        }
        #home-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            background-color: #fff;
            border-radius: 8px;
        }
        #home-container h1 {
            font-size: 3.75rem; /* ~60px */
            margin-bottom: 20px;
        }
        #start-button {
            padding: 15px 30px;
            font-size: 1.875rem; /* ~30px */
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        #start-button:hover {
            background-color: #0056b3;
        }
        #right-pane {
            flex: 1;
            background-color: #fff;
            padding: 20px;
            border-left: 1px solid #ddd;
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        #webcam-confidence-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        #webcam-container {
            width: 200px;
            height: 200px;
            border: 2px solid #333;
            border-radius: 8px;
            margin-right: 10px;
        }
        #confidence-container {
            width: 200px;
            font-size: 1.25rem; /* ~20px */
        }
        #confidence-container div {
            margin-bottom: 5px;
        }
        #dashboard-container {
            flex: 1;
            width: 100%;
        }
        #question-box {
            background-color: #fff;
            border: 2px solid #333;
            border-radius: 8px;
            padding: 30px 20px;
            margin-bottom: 20px;
            width: 800px;
            height: 120px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #question-number {
            font-size: 2.5rem; /* ~40px */
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        #question-text {
            font-size: 2.1875rem; /* ~35px */
            text-align: center;
        }
        #time-counter {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 1.875rem; /* ~30px */
            color: #721c24;
            font-weight: bold;
        }
        #options-area {
            width: 400px;
            height: 400px;
            position: relative;
            margin: 20px auto;
        }
        .option-button {
            position: absolute;
            width: 150px;
            height: 60px;
            padding: 10px;
            border: 1px solid #333;
            border-radius: 5px;
            cursor: default;
            font-size: 1.5625rem; /* ~25px */
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #option-A { top: 0; left: 50%; transform: translateX(-50%); background-color: #d1e7dd; }
        #option-B { top: 50%; left: 0; transform: translateY(-50%); background-color: #f8d7da; }
        #option-C { top: 50%; right: 0; transform: translateY(-50%); background-color: #cff4fc; }
        #option-D { bottom: 0; left: 50%; transform: translateX(-50%); background-color: #fff3cd; }
        .option-button.correct {
            background-color: #d4edda !important;
            color: #155724;
            border-color: #c3e6cb;
        }
        .option-button.wrong {
            background-color: #f8d7da !important;
            color: #721c24;
            border-color: #f5c6cb;
        }
        #feedback-message {
            margin-top: 15px;
            font-size: 1.875rem; /* ~30px */
            font-weight: bold;
            min-height: 30px;
        }
        #feedback-message.correct { color: green; }
        #feedback-message.wrong { color: red; }
        #score-container {
            margin-top: 20px;
            font-size: 2.1875rem; /* ~35px */
            font-weight: bold;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        #restart-button {
            padding: 12px 24px;
            font-size: 1.5625rem; /* ~25px */
            background: linear-gradient(45deg, #007bff, #00d4ff);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 10px;
        }
        #restart-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0,0,0,0.2);
        }
        #dashboard-container h2 {
            font-size: 1.875rem; /* ~30px */
            margin-bottom: 15px;
            text-align: center;
        }
        #dashboard-table {
            width: 100%;
            border-collapse: collapse;
        }
        #dashboard-table th, #dashboard-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
            font-size: 1.5625rem; /* ~25px */
        }
        #dashboard-table th {
            background-color: #f9f9f9;
        }
        #total-score {
            margin-top: 15px;
            font-size: 1.875rem; /* ~30px */
            font-weight: bold;
            text-align: center;
        }
        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div id="main-container">
        <div id="quiz-container">
            <div id="home-container">
                <h1>Welcome to the Camera Quiz Game</h1>
                <button id="start-button" onclick="startGame()">Start Game</button>
            </div>
            <div id="game-container" class="hidden">
                <div id="question-box">
                    <div id="question-number"></div>
                    <div id="question-text">Loading question...</div>
                    <div id="time-counter">Time: 7</div>
                </div>
                <div id="options-area"></div>
                <div id="feedback-message"></div>
                <div id="score-container" class="hidden">
                    <h2>Quiz Completed!</h2>
                    <p id="final-score"></p>
                    <button id="restart-button" onclick="restartGame()">Play Again?</button>
                </div>
            </div>
        </div>
        <div id="right-pane">
            <div id="webcam-confidence-container">
                <div id="webcam-container"></div>
                <div id="confidence-container">
                    <div id="confidence-A">A: 0.00%</div>
                    <div id="confidence-B">B: 0.00%</div>
                    <div id="confidence-C">C: 0.00%</div>
                    <div id="confidence-D">D: 0.00%</div>
                </div>
            </div>
            <div id="dashboard-container">
                <h2>Score Dashboard</h2>
                <table id="dashboard-table">
                    <thead>
                        <tr>
                            <th>Question</th>
                            <th>Points</th>
                        </tr>
                    </thead>
                    <tbody id="dashboard-body"></tbody>
                </table>
                <div id="total-score">Total: 0</div>
            </div>
        </div>
    </div>
    <div id="label-container" style="display: none;"></div>

    <script>
        const URL = 'https://teachablemachine.withgoogle.com/models/HUm1gixqh/';
        const jsonUrl = 'https://ylpss-mslau.github.io/questions_v1.json';
        let model, webcam, labelContainer, maxPredictions;
        let allQuestions = [], selectedQuestions = [];
        let currentQuestionIndex = 0, totalScore = 0;
        const questionsPerGame = 10;
        const WAIT_TIME = 200;
        let isIos = /iPhone|iPad/.test(window.navigator.userAgent);
        let answerConfirmed = false, confidenceStartTime = null;
        let questionStartTime, optionsTimeout, timerInterval;
        const scores = Array(questionsPerGame).fill(null);

        // DOM Elements
        const homeContainerElement = document.getElementById('home-container');
        const gameContainerElement = document.getElementById('game-container');
        const questionBoxElement = document.getElementById('question-box');
        const questionNumberElement = document.getElementById('question-number');
        const questionTextElement = document.getElementById('question-text');
        const timeCounterElement = document.getElementById('time-counter');
        const optionsAreaElement = document.getElementById('options-area');
        const feedbackMessageElement = document.getElementById('feedback-message');
        const scoreContainerElement = document.getElementById('score-container');
        const finalScoreElement = document.getElementById('final-score');
        const dashboardBodyElement = document.getElementById('dashboard-body');
        const totalScoreElement = document.getElementById('total-score');
        const restartButtonElement = document.getElementById('restart-button');
        const confidenceElements = {
            A: document.getElementById('confidence-A'),
            B: document.getElementById('confidence-B'),
            C: document.getElementById('confidence-C'),
            D: document.getElementById('confidence-D')
        };

        // Webcam Initialization
        async function initWebcam() {
            const modelURL = URL + 'model.json';
            const metadataURL = URL + 'metadata.json';
            try {
                model = await tmImage.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();
                const flip = true;
                webcam = new tmImage.Webcam(200, 200, flip);
                if (!(await checkCamera())) return false;
                await webcam.setup();
                if (isIos) {
                    document.getElementById('webcam-container').appendChild(webcam.webcam);
                    const webCamVideo = document.getElementsByTagName('video')[0];
                    webCamVideo.setAttribute("playsinline", true);
                    webCamVideo.muted = "true";
                    webCamVideo.style.width = '200px';
                    webCamVideo.style.height = '200px';
                } else {
                    document.getElementById('webcam-container').appendChild(webcam.canvas);
                }
                labelContainer = document.getElementById('label-container');
                for (let i = 0; i < maxPredictions; i++) {
                    labelContainer.appendChild(document.createElement('div'));
                }
                webcam.play();
                window.requestAnimationFrame(loop);
                return true;
            } catch (e) {
                alert("Failed to access webcam: " + e.message);
                return false;
            }
        }

        async function loop() {
            await new Promise(r => setTimeout(r, WAIT_TIME));
            webcam.update();
            await predict();
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            if (answerConfirmed || currentQuestionIndex >= selectedQuestions.length) return;
            const prediction = isIos ? await model.predict(webcam.webcam) : await model.predict(webcam.canvas);
            let highest = -1, result;
            for (let i = 0; i < maxPredictions; i++) {
                const prob = prediction[i].probability;
                const probPercent = (prob * 100).toFixed(2);
                const className = prediction[i].className;
                labelContainer.childNodes[i].innerHTML = `${className}: ${probPercent}%`;
                if (confidenceElements[className]) {
                    confidenceElements[className].textContent = `${className}: ${probPercent}%`;
                }
                if (prob > highest) {
                    result = prediction[i];
                    highest = prob;
                }
            }
            if (result.probability >= 0.8) {
                if (!confidenceStartTime) {
                    confidenceStartTime = Date.now();
                } else if (Date.now() - confidenceStartTime >= 3000) { // 3 seconds
                    answerConfirmed = true;
                    handleAnswer(result.className);
                }
            } else {
                confidenceStartTime = null;
            }
        }

        async function checkCamera() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            if (videoDevices.length === 0) {
                alert("No camera detected.");
                return false;
            }
            return true;
        }

        // Quiz Logic
        async function fetchQuestions() {
            try {
                questionTextElement.textContent = "Fetching questions...";
                const response = await fetch(jsonUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                allQuestions = await response.json();
                if (!Array.isArray(allQuestions) || allQuestions.length === 0) {
                    questionTextElement.textContent = "No questions found.";
                    return;
                }
                homeContainerElement.classList.remove('hidden');
            } catch (error) {
                questionTextElement.textContent = `Error: ${error.message}.`;
            }
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        async function startGame() {
            if (!(await initWebcam())) return;
            homeContainerElement.classList.add('hidden');
            gameContainerElement.classList.remove('hidden');
            questionBoxElement.classList.remove('hidden');
            totalScore = 0;
            currentQuestionIndex = 0;
            selectedQuestions = [];
            answerConfirmed = false;
            confidenceStartTime = null;
            feedbackMessageElement.textContent = '';
            feedbackMessageElement.className = '';
            scoreContainerElement.classList.add('hidden');
            questionTextElement.classList.remove('hidden');
            optionsAreaElement.classList.remove('hidden');
            scores.fill(null);
            updateDashboard();

            // Reset confidence display
            Object.values(confidenceElements).forEach(el => el.textContent = `${el.id.replace('confidence-', '')}: 0.00%`);

            shuffleArray(allQuestions);
            selectedQuestions = allQuestions.slice(0, Math.min(allQuestions.length, questionsPerGame));
            if (selectedQuestions.length > 0) {
                displayQuestion();
            } else {
                questionTextElement.textContent = "Not enough questions.";
            }
        }

        function startTimer() {
            clearInterval(timerInterval);
            let timeLeft = 7;
            timeCounterElement.textContent = `Time: ${timeLeft}`;
            let optionsShown = false;
            timerInterval = setInterval(() => {
                timeLeft--;
                timeCounterElement.textContent = `Time: ${timeLeft}`;
                if (timeLeft === 6 && !optionsShown) {
                    optionsAreaElement.style.display = 'block';
                    optionsShown = true;
                }
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    if (!answerConfirmed) {
                        scores[currentQuestionIndex] = 0;
                        updateDashboard();
                        moveToNextQuestion();
                    }
                }
            }, 1000);
        }

        function displayQuestion() {
            clearTimeout(optionsTimeout);
            clearInterval(timerInterval);
            answerConfirmed = false;
            confidenceStartTime = null;
            feedbackMessageElement.textContent = '';
            feedbackMessageElement.className = '';
            optionsAreaElement.innerHTML = '';
            optionsAreaElement.style.display = 'none';

            if (currentQuestionIndex >= selectedQuestions.length) {
                endGame();
                return;
            }

            const currentQuestion = selectedQuestions[currentQuestionIndex];
            questionNumberElement.textContent = `Question ${currentQuestionIndex + 1}/${selectedQuestions.length}`;
            questionTextElement.textContent = currentQuestion.question;
            startTimer();

            if (currentQuestion.options && typeof currentQuestion.options === 'object') {
                Object.entries(currentQuestion.options).forEach(([key, value]) => {
                    const button = document.createElement('div');
                    button.className = 'option-button';
                    button.id = `option-${key}`;
                    button.textContent = `${key}: ${value}`;
                    button.dataset.optionKey = key;
                    optionsAreaElement.appendChild(button);
                });
            } else {
                questionTextElement.textContent = `Error: Question ${currentQuestionIndex + 1} has no options.`;
                setTimeout(() => {
                    currentQuestionIndex++;
                    displayQuestion();
                }, 1500);
                return;
            }

            questionStartTime = Date.now();
        }

        function handleAnswer(selectedOption) {
            clearInterval(timerInterval);
            const currentQuestion = selectedQuestions[currentQuestionIndex];
            const correctAnswerKey = currentQuestion.correct_answer;
            const selectedButton = optionsAreaElement.querySelector(`#option-${selectedOption}`);
            const correctButton = optionsAreaElement.querySelector(`#option-${correctAnswerKey}`);

            if (selectedOption === correctAnswerKey) {
                scores[currentQuestionIndex] = 2;
                totalScore += 2;
                feedbackMessageElement.textContent = 'Correct!';
                feedbackMessageElement.className = 'correct';
                if (selectedButton) selectedButton.classList.add('correct');
            } else {
                scores[currentQuestionIndex] = -1;
                totalScore -= 1;
                feedbackMessageElement.textContent = 'Wrong!';
                feedbackMessageElement.className = 'wrong';
                if (selectedButton) selectedButton.classList.add('wrong');
                if (correctButton) correctButton.classList.add('correct');
            }

            updateDashboard();
            setTimeout(moveToNextQuestion, 1000);
        }

        function moveToNextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }

        function updateDashboard() {
            dashboardBodyElement.innerHTML = '';
            scores.forEach((score, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${index + 1}</td><td>${score !== null ? score : '-'}</td>`;
                dashboardBodyElement.appendChild(row);
            });
            totalScoreElement.textContent = `Total: ${totalScore}`;
        }

        function endGame() {
            clearInterval(timerInterval);
            questionBoxElement.classList.add('hidden');
            optionsAreaElement.classList.add('hidden');
            feedbackMessageElement.textContent = '';
            feedbackMessageElement.className = '';
            finalScoreElement.textContent = `Your final score is: ${totalScore}.`;
            scoreContainerElement.classList.remove('hidden');
            restartButtonElement.style.display = 'block';
        }

        function restartGame() {
            startGame();
            scoreContainerElement.classList.add('hidden');
        }

        // Start by fetching questions
        fetchQuestions();
    </script>
</body>
</html>
